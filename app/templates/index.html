{% extends "base.html" %}

{% block content %}
<div class="blockchain-bg">
    <div class="row">
        <!-- Voting Section -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-vote-yea me-2"></i>
                        Cast Your Vote
                    </h4>
                </div>
                <div class="card-body">
                    <form action="/submit" method="post" id="voteForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-users me-2"></i>
                                    Select Political Party
                                </label>
                                <select name="party" class="form-select form-select-lg" required>
                                    <option value="">Choose a party...</option>
                                    {% for political_partie in political_parties %}
                                    <option value="{{political_partie}}">{{political_partie}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-id-card me-2"></i>
                                    Enter Voter ID
                                </label>
                                <input type="text" name="voter_id" class="form-control form-control-lg" 
                                       placeholder="e.g., VOID001" required>
                                <div class="form-text">Select from sample Voter IDs on the right</div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-vote-yea me-2"></i>
                                Submit Vote
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sample Voter IDs Section -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Sample Voter IDs
                    </h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div class="row">
                        {% for voter_id in voter_ids %}
                        <div class="col-6 mb-2">
                            <span class="badge bg-secondary fs-6 voter-id-badge" 
                                  style="cursor: pointer;" 
                                  onclick="selectVoterID('{{voter_id}}')">
                                {{voter_id}}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Blockchain Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Blockchain Operations
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{node_address}}/mine" target="_blank" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-pickaxe me-2"></i>
                            Mine New Block
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Data
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{node_address}}/chain" target="_blank" class="btn btn-secondary btn-lg w-100">
                            <i class="fas fa-link me-2"></i>
                            View Blockchain
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="row">
    <!-- Vote Summary -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Vote Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Party</th>
                                <th>Votes</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total_votes = vote_gain|length %}
                            {% for p in political_parties %}
                            {% set party_votes = vote_gain.count(p) %}
                            <tr>
                                <td>
                                    <strong>{{p}}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{party_votes}}</span>
                                </td>
                                <td>
                                    {% if total_votes > 0 %}
                                    {% set percentage = (party_votes/total_votes*100)|round(1) %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             data-width="{{percentage}}">
                                            {{percentage}}%
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Total Votes: {{total_votes}}
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Results -->
    <div class="col-xl-8 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Detailed Vote Records
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Voter ID</th>
                                <th>Party</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in posts %}
                            <tr>
                                <td>
                                    <code>{{post.voter_id}}</code>
                                </td>
                                <td>
                                    <strong>{{post.party}}</strong>
                                </td>
                                <td>
                                    <small>{{readable_time(post.timestamp)}}</small>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>
                                        Confirmed
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if posts|length == 0 %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-inbox me-2"></i>
                                    No votes recorded yet
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectVoterID(voterID) {
    document.querySelector('input[name="voter_id"]').value = voterID;
    
    // Add visual feedback
    const badge = event.target;
    badge.classList.add('bg-success');
    badge.classList.remove('bg-secondary');
    
    // Reset other badges
    document.querySelectorAll('.voter-id-badge').forEach(el => {
        if (el !== badge) {
            el.classList.add('bg-secondary');
            el.classList.remove('bg-success');
        }
    });
}

// Add form validation
document.getElementById('voteForm').addEventListener('submit', function(e) {
    const party = document.querySelector('select[name="party"]').value;
    const voterID = document.querySelector('input[name="voter_id"]').value;
    
    if (!party || !voterID) {
        e.preventDefault();
        alert('Please select a party and enter a voter ID');
        return;
    }
    
    // Add loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting Vote...';
    submitBtn.disabled = true;
});

// Set progress bar widths dynamically
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar[data-width]');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
});
</script>

<style>
.voter-id-badge {
    transition: all 0.3s ease;
}

.voter-id-badge:hover {
    transform: scale(1.05);
}

.progress {
    background-color: #e9ecef;
}

.progress-bar {
    background: linear-gradient(45deg, #007bff, #0056b3);
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 0 0; }
    100% { background-position: 40px 0; }
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>
{% endblock %}
